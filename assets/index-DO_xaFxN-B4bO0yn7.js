import{m as D,k as Y,a as Z}from"./inline-latex-C9IGAXXQ-Bi8O4X4y.js";import{F as J,C as K,k as O,P as V,W,Q as j,U as tt}from"./index-BKZqlHfW.js";import{d as et}from"./index-D6fLMv29-CeGVhQwU.js";import{q as nt,b as rt,h as at,i as it}from"./functions-Bsik6ikd-D8GGRsLx.js";import{o as C,F as ot,f as S,m as F,y as ut}from"./syntax-2Kab1CR3.js";import{c as lt}from"./index.es-Bnv9eU2G.js";import{W as st,V as ht}from"./index.es-Ce_HC4-m.js";import{N as ct,b as mt,E as dt,k as pt,S as xt,B as L,z as wt}from"./index-CCHPmTqj.js";import"./pro-components-CPZIsSOc.js";import"./antd-Cl3cKmq-.js";import"./json-editor-D3HpTOiY.js";import"./index.browser-B0na17u1.js";import"./index-BUFMBfDr.js";import"./hooks-Dt0wL0oo.js";import"./floating-ui.dom-DtR07Cup.js";import"./index-DkoMvkBT.js";import"./index-6kZY_JYa.js";function ft(){return{enter:{mathFlow:t,mathFlowFenceMeta:e,mathText:l},exit:{mathFlow:n,mathFlowFence:a,mathFlowFenceMeta:r,mathFlowValue:h,mathText:s,mathTextData:h}};function t(o){const c={type:"element",tagName:"code",properties:{className:["language-math","math-display"]},children:[]};this.enter({type:"math",meta:null,value:"",data:{hName:"pre",hChildren:[c]}},o)}function e(){this.buffer()}function r(){const o=this.resume(),c=this.stack[this.stack.length-1];C(c.type==="math"),c.meta=o}function a(){this.data.mathFlowInside||(this.buffer(),this.data.mathFlowInside=!0)}function n(o){const c=this.resume().replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),m=this.stack[this.stack.length-1];C(m.type==="math"),this.exit(o),m.value=c;const p=m.data.hChildren[0];C(p.type==="element"),C(p.tagName==="code"),p.children.push({type:"text",value:c}),this.data.mathFlowInside=void 0}function l(o){this.enter({type:"inlineMath",value:"",data:{hName:"code",hProperties:{className:["language-math","math-inline"]},hChildren:[]}},o),this.buffer()}function s(o){const c=this.resume(),m=this.stack[this.stack.length-1];C(m.type==="inlineMath"),this.exit(o),m.value=c,m.data.hChildren.push({type:"text",value:c})}function h(o){this.config.enter.data.call(this,o),this.config.exit.data.call(this,o)}}function kt(t){let e=(t||{}).singleDollarTextMath;return e==null&&(e=!0),a.peek=n,{unsafe:[{character:"\r",inConstruct:"mathFlowMeta"},{character:`
`,inConstruct:"mathFlowMeta"},{character:"$",after:e?void 0:"\\$",inConstruct:"phrasing"},{character:"$",inConstruct:"mathFlowMeta"},{atBreak:!0,character:"$",after:"\\$"}],handlers:{math:r,inlineMath:a}};function r(l,s,h,o){const c=l.value||"",m=h.createTracker(o),p="$".repeat(Math.max(ot(c,"$")+1,2)),x=h.enter("mathFlow");let d=m.move(p);if(l.meta){const w=h.enter("mathFlowMeta");d+=m.move(h.safe(l.meta,{after:`
`,before:d,encode:["$"],...m.current()})),w()}return d+=m.move(`
`),c&&(d+=m.move(c+`
`)),d+=m.move(p),x(),d}function a(l,s,h){let o=l.value||"",c=1;for(e||c++;new RegExp("(^|[^$])"+"\\$".repeat(c)+"([^$]|$)").test(o);)c++;const m="$".repeat(c);/[^ \r\n]/.test(o)&&(/^[ \r\n]/.test(o)&&/[ \r\n]$/.test(o)||/^\$|\$$/.test(o))&&(o=" "+o+" ");let p=-1;for(;++p<h.unsafe.length;){const x=h.unsafe[p];if(!x.atBreak)continue;const d=h.compilePattern(x);let w;for(;w=d.exec(o);){let u=w.index;o.codePointAt(u)===10&&o.codePointAt(u-1)===13&&u--,o=o.slice(0,u)+" "+o.slice(w.index+1)}}return m+o+m}function n(){return"$"}}const Mt={tokenize:gt,concrete:!0,name:"mathFlow"},N={tokenize:Ft,partial:!0};function gt(t,e,r){const a=this,n=a.events[a.events.length-1],l=n&&n[1].type==="linePrefix"?n[2].sliceSerialize(n[1],!0).length:0;let s=0;return h;function h(i){return t.enter("mathFlow"),t.enter("mathFlowFence"),t.enter("mathFlowFenceSequence"),o(i)}function o(i){return i===36?(t.consume(i),s++,o):s<2?r(i):(t.exit("mathFlowFenceSequence"),S(t,c,"whitespace")(i))}function c(i){return i===null||F(i)?p(i):(t.enter("mathFlowFenceMeta"),t.enter("chunkString",{contentType:"string"}),m(i))}function m(i){return i===null||F(i)?(t.exit("chunkString"),t.exit("mathFlowFenceMeta"),p(i)):i===36?r(i):(t.consume(i),m)}function p(i){return t.exit("mathFlowFence"),a.interrupt?e(i):t.attempt(N,x,T)(i)}function x(i){return t.attempt({tokenize:U,partial:!0},T,d)(i)}function d(i){return(l?S(t,w,"linePrefix",l+1):w)(i)}function w(i){return i===null?T(i):F(i)?t.attempt(N,x,T)(i):(t.enter("mathFlowValue"),u(i))}function u(i){return i===null||F(i)?(t.exit("mathFlowValue"),w(i)):(t.consume(i),u)}function T(i){return t.exit("mathFlow"),e(i)}function U(i,G,z){let I=0;return S(i,H,"linePrefix",a.parser.constructs.disable.null.includes("codeIndented")?void 0:4);function H(k){return i.enter("mathFlowFence"),i.enter("mathFlowFenceSequence"),q(k)}function q(k){return k===36?(I++,i.consume(k),q):I<s?z(k):(i.exit("mathFlowFenceSequence"),S(i,Q,"whitespace")(k))}function Q(k){return k===null||F(k)?(i.exit("mathFlowFence"),G(k)):z(k)}}}function Ft(t,e,r){const a=this;return n;function n(s){return s===null?e(s):(t.enter("lineEnding"),t.consume(s),t.exit("lineEnding"),l)}function l(s){return a.parser.lazy[a.now().line]?r(s):e(s)}}function yt(t){let r=(t||{}).singleDollarTextMath;return r==null&&(r=!0),{tokenize:a,resolve:Et,previous:Ct,name:"mathText"};function a(n,l,s){let h=0,o,c;return m;function m(u){return n.enter("mathText"),n.enter("mathTextSequence"),p(u)}function p(u){return u===36?(n.consume(u),h++,p):h<2&&!r?s(u):(n.exit("mathTextSequence"),x(u))}function x(u){return u===null?s(u):u===36?(c=n.enter("mathTextSequence"),o=0,w(u)):u===32?(n.enter("space"),n.consume(u),n.exit("space"),x):F(u)?(n.enter("lineEnding"),n.consume(u),n.exit("lineEnding"),x):(n.enter("mathTextData"),d(u))}function d(u){return u===null||u===32||u===36||F(u)?(n.exit("mathTextData"),x(u)):(n.consume(u),d)}function w(u){return u===36?(n.consume(u),o++,w):o===h?(n.exit("mathTextSequence"),n.exit("mathText"),l(u)):(c.type="mathTextData",d(u))}}}function Et(t){let e=t.length-4,r=3,a,n;if((t[r][1].type==="lineEnding"||t[r][1].type==="space")&&(t[e][1].type==="lineEnding"||t[e][1].type==="space")){for(a=r;++a<e;)if(t[a][1].type==="mathTextData"){t[e][1].type="mathTextPadding",t[r][1].type="mathTextPadding",r+=2,e-=2;break}}for(a=r-1,e++;++a<=e;)n===void 0?a!==e&&t[a][1].type!=="lineEnding"&&(n=a):(a===e||t[a][1].type==="lineEnding")&&(t[n][1].type="mathTextData",a!==n+2&&(t[n][1].end=t[a-1][1].end,t.splice(n+2,a-n-2),e-=a-n-2,a=n+2),n=void 0);return t}function Ct(t){return t!==36||this.events[this.events.length-1][1].type==="characterEscape"}function vt(t){return{flow:{36:Mt},text:{36:yt(t)}}}const Tt={};function St(t){const e=this,r=t||Tt,a=e.data(),n=a.micromarkExtensions||(a.micromarkExtensions=[]),l=a.fromMarkdownExtensions||(a.fromMarkdownExtensions=[]),s=a.toMarkdownExtensions||(a.toMarkdownExtensions=[]);n.push(vt(r)),l.push(ft()),s.push(kt(r))}const $t=O("remarkMath",()=>St);function _t(t){return ut(t,"math",(e,r,a)=>{const{value:n}=e,l={type:"code",lang:"LaTeX",value:n};a.children.splice(r,1,l)})}const bt=O("remarkMathBlock",()=>()=>_t),B=({config:t,innerView:e,updateValue:r})=>{var a;const n=l=>{l.preventDefault(),r==null||r()};return at`
    <host>
      <div class="container">
        ${e&&it(e.dom,{})}
        <button onmousedown=${n}>
          ${(a=t==null?void 0:t.inlineEditConfirm)==null?void 0:a.call(t)}
        </button>
      </div>
    </host>
  `};B.props={config:Object,innerView:Object,updateValue:Function};const A=rt(B),P=st("INLINE_LATEX");var R=t=>{throw TypeError(t)},X=(t,e,r)=>e.has(t)||R("Cannot "+r),f=(t,e,r)=>(X(t,e,"read from private field"),r?r.call(t):e.get(t)),y=(t,e,r)=>e.has(t)?R("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),v=(t,e,r,a)=>(X(t,e,"write to private field"),e.set(t,r),r),M,E,$,g,_,b;class zt{constructor(e,r,a){this.ctx=e,y(this,M,new A),y(this,E),y(this,$),y(this,g),y(this,_,()=>{f(this,g)&&(f(this,g).destroy(),v(this,g,null))}),y(this,b,n=>{const s=(()=>{const{selection:h,schema:o}=n.state;if(h.empty||!(h instanceof ct))return!1;const c=h.node;if(c.type.name!==Z)return!1;const m=h.from,p=o.nodes.paragraph.create(null,o.text(c.attrs.value)),x=new mt(f(this,$),{state:dt.create({doc:p,schema:new xt({nodes:{doc:{content:"block+"},paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p"}],toDOM(){return["p",0]}},text:{group:"inline"}}}),plugins:[pt({"Mod-z":wt,"Mod-Z":L,"Mod-y":L,Enter:()=>{var d,w;return(w=(d=f(this,M)).updateValue)==null||w.call(d),!0}})]})});return v(this,g,x),f(this,M).innerView=f(this,g),f(this,M).updateValue=()=>{const{tr:d}=n.state;d.setNodeAttribute(m,"value",x.state.doc.textContent),n.dispatch(d),requestAnimationFrame(()=>{n.focus()})},!0})();return s||f(this,_).call(this),s}),this.update=(n,l)=>{f(this,E).update(n,l)},this.destroy=()=>{f(this,E).destroy(),f(this,M).remove()},v(this,E,new ht({debounce:0,content:f(this,M),shouldShow:f(this,b),offset:10,floatingUIOptions:{placement:"bottom"}})),f(this,M).config=a,f(this,E).update(r),v(this,$,document.createElement("div")),v(this,g,null)}}M=new WeakMap;E=new WeakMap;$=new WeakMap;g=new WeakMap;_=new WeakMap;b=new WeakMap;const It=V(t=>j(/(?:\$)([^$]+)(?:\$)$/,D.type(t),{getAttr:e=>{var r;return{value:(r=e[1])!=null?r:""}}})),qt=V(t=>tt(/^\$\$[\s\n]$/,W.type(t),()=>({language:"LaTeX"}))),Lt=W.extendSchema(t=>e=>{const r=t(e);return{...r,toMarkdown:{match:r.toMarkdown.match,runner:(a,n)=>{var l,s;if(((l=n.attrs.language)!=null?l:"").toLowerCase()==="latex")a.addNode("math",void 0,((s=n.content.firstChild)==null?void 0:s.text)||"");else return r.toMarkdown.runner(a,n)}}}});et("milkdown-latex-inline-edit",A);const jt=(t,e)=>{t.config(r=>{if(!r.get(J).includes(K.CodeMirror))throw new Error("You need to enable CodeMirror to use LaTeX feature");r.update(lt.key,l=>({...l,renderPreview:(s,h)=>{if(s.toLowerCase()==="latex"&&h.length>0)return Nt(h,e==null?void 0:e.katexOptions);const o=l.renderPreview;return o(s,h)}})),r.set(P.key,{view:l=>{var s;return new zt(r,l,{inlineEditConfirm:(s=e==null?void 0:e.inlineEditConfirm)!=null?s:()=>nt,...e})}})}).use($t).use(bt).use(D).use(P).use(It).use(qt).use(Lt)};function Nt(t,e){return Y.renderToString(t,{...e,throwOnError:!1,displayMode:!0})}export{jt as defineFeature};
